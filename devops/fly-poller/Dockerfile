############################################################
# StakTrakr All-in-One Fly.io Container
# ─────────────────────────────────────
# Runs the full retail-poller pipeline in a single container:
#   1. Redis           — Firecrawl queue + rate limiting
#   2. RabbitMQ        — Firecrawl job queue
#   3. PostgreSQL 17   — Firecrawl internal DB (pg_cron)
#   4. Firecrawl API   — Scraping endpoint (port 3002)
#   5. Firecrawl Worker + extract-worker + nuq-workers
#   6. Playwright Svc  — Headless Chrome for Firecrawl (port 3003)
#   7. Cron            — retail-poller 15-min cycle
#   8. serve.js        — Public HTTP API (port 8080)
#
# All processes managed by supervisord.
############################################################

# ── Stage 1: Firecrawl app (API + workers) ──────────────
FROM ghcr.io/firecrawl/firecrawl:latest AS firecrawl

# ── Stage 2: Playwright service ─────────────────────────
FROM ghcr.io/firecrawl/playwright-service:latest AS playwright-svc

# ── Stage 3: Final all-in-one image ─────────────────────
FROM node:20-slim

ENV DEBIAN_FRONTEND=noninteractive

# System packages: git, cron, supervisor, redis, rabbitmq, postgres, chromium deps
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    cron \
    ca-certificates \
    supervisor \
    redis-server \
    rabbitmq-server \
    python3 \
    make \
    g++ \
    curl \
    gnupg \
    lsb-release \
    # Chromium dependencies for Playwright service
    libnss3 \
    libnspr4 \
    libatk1.0-0 \
    libatk-bridge2.0-0 \
    libcups2 \
    libdrm2 \
    libdbus-1-3 \
    libxkbcommon0 \
    libxcomposite1 \
    libxdamage1 \
    libxfixes3 \
    libxrandr2 \
    libgbm1 \
    libpango-1.0-0 \
    libcairo2 \
    libasound2 \
    libatspi2.0-0 \
    libwayland-client0 \
    && rm -rf /var/lib/apt/lists/*

# ── Block ad/tracker domains at OS level ──────────────────
# Prevents Chromium from loading trackers during scrapes, reducing CPU and
# bandwidth by ~30-50%. Domains resolve to 0.0.0.0 instantly (no TCP handshake).
# Source: AdGuard base list + observed bullion dealer page trackers.
# NOTE: /etc/hosts is read-only during Docker build (BuildKit restriction).
# We write to a staging file here; docker-entrypoint.sh appends it at runtime.
RUN printf '%s\n' \
  '# --- Ad networks & trackers (blocked for scraper performance) ---' \
  '0.0.0.0 www.googletagmanager.com' \
  '0.0.0.0 googletagmanager.com' \
  '0.0.0.0 www.google-analytics.com' \
  '0.0.0.0 google-analytics.com' \
  '0.0.0.0 ssl.google-analytics.com' \
  '0.0.0.0 analytics.google.com' \
  '0.0.0.0 www.googleadservices.com' \
  '0.0.0.0 googleads.g.doubleclick.net' \
  '0.0.0.0 pagead2.googlesyndication.com' \
  '0.0.0.0 adservice.google.com' \
  '0.0.0.0 pagead.l.doubleclick.net' \
  '0.0.0.0 tpc.googlesyndication.com' \
  '0.0.0.0 connect.facebook.net' \
  '0.0.0.0 www.facebook.com' \
  '0.0.0.0 pixel.facebook.com' \
  '0.0.0.0 graph.facebook.com' \
  '0.0.0.0 bat.bing.com' \
  '0.0.0.0 clarity.ms' \
  '0.0.0.0 www.clarity.ms' \
  '0.0.0.0 cdn.klaviyo.com' \
  '0.0.0.0 static.klaviyo.com' \
  '0.0.0.0 a.klaviyo.com' \
  '0.0.0.0 fast.a.klaviyo.com' \
  '0.0.0.0 tr.snapchat.com' \
  '0.0.0.0 sc-static.net' \
  '0.0.0.0 px.ads.linkedin.com' \
  '0.0.0.0 snap.licdn.com' \
  '0.0.0.0 analytics.tiktok.com' \
  '0.0.0.0 ct.pinterest.com' \
  '0.0.0.0 static.hotjar.com' \
  '0.0.0.0 script.hotjar.com' \
  '0.0.0.0 vars.hotjar.com' \
  '0.0.0.0 js.hs-analytics.net' \
  '0.0.0.0 js.hs-scripts.com' \
  '0.0.0.0 track.hubspot.com' \
  '0.0.0.0 js.hsforms.net' \
  '0.0.0.0 cdn.segment.com' \
  '0.0.0.0 api.segment.io' \
  '0.0.0.0 cdn.amplitude.com' \
  '0.0.0.0 cdn.optimizely.com' \
  '0.0.0.0 logx.optimizely.com' \
  '0.0.0.0 cdn.heapanalytics.com' \
  '0.0.0.0 cdn.mouseflow.com' \
  '0.0.0.0 cdn.luckyorange.com' \
  '0.0.0.0 cdn.onesignal.com' \
  '0.0.0.0 widget.intercom.io' \
  '0.0.0.0 js.intercomcdn.com' \
  '0.0.0.0 static.doubleclick.net' \
  '0.0.0.0 ad.doubleclick.net' \
  '0.0.0.0 stats.g.doubleclick.net' \
  '0.0.0.0 cm.g.doubleclick.net' \
  '0.0.0.0 securepubads.g.doubleclick.net' \
  '0.0.0.0 c.amazon-adsystem.com' \
  '0.0.0.0 s.amazon-adsystem.com' \
  '0.0.0.0 z-na.amazon-adsystem.com' \
  '0.0.0.0 aax.amazon-adsystem.com' \
  '0.0.0.0 fls-na.amazon-adsystem.com' \
  '0.0.0.0 mads.amazon-adsystem.com' \
  '0.0.0.0 aan.amazon.com' \
  '0.0.0.0 ads.yahoo.com' \
  '0.0.0.0 ads.pubmatic.com' \
  '0.0.0.0 gum.criteo.com' \
  '0.0.0.0 static.criteo.net' \
  '0.0.0.0 bidder.criteo.com' \
  '0.0.0.0 dis.criteo.com' \
  '0.0.0.0 ib.adnxs.com' \
  '0.0.0.0 secure.adnxs.com' \
  '0.0.0.0 prebid.adnxs.com' \
  '0.0.0.0 match.adsrvr.org' \
  '0.0.0.0 insight.adsrvr.org' \
  '0.0.0.0 js-agent.newrelic.com' \
  '0.0.0.0 bam.nr-data.net' \
  '0.0.0.0 consent.cookiebot.com' \
  '0.0.0.0 cdn.cookielaw.org' \
  '0.0.0.0 geolocation.onetrust.com' \
  '0.0.0.0 tags.tiqcdn.com' \
  '0.0.0.0 cdn.taboola.com' \
  '0.0.0.0 trc.taboola.com' \
  '0.0.0.0 widgets.outbrain.com' \
  '0.0.0.0 log.outbrain.com' \
  '0.0.0.0 assets.adobedtm.com' \
  '0.0.0.0 dpm.demdex.net' \
  > /tmp/tracker-blocklist.txt

# Install Tailscale (stable Debian bookworm repo)
RUN curl -fsSL https://pkgs.tailscale.com/stable/debian/bookworm.noarmor.gpg \
      > /usr/share/keyrings/tailscale-archive-keyring.gpg \
    && curl -fsSL https://pkgs.tailscale.com/stable/debian/bookworm.tailscale-keyring.list \
      > /etc/apt/sources.list.d/tailscale.list \
    && apt-get update \
    && apt-get install -y --no-install-recommends tailscale iptables \
    && rm -rf /var/lib/apt/lists/*

# Install PostgreSQL 17
RUN curl -fsSL https://www.postgresql.org/media/keys/ACCC4CF8.asc | gpg --dearmor -o /usr/share/keyrings/pgdg.gpg \
    && echo "deb [signed-by=/usr/share/keyrings/pgdg.gpg] http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" \
        > /etc/apt/sources.list.d/pgdg.list \
    && apt-get update \
    && apt-get install -y --no-install-recommends postgresql-17 postgresql-17-cron \
    && rm -rf /var/lib/apt/lists/*

# ── Copy Firecrawl app ──────────────────────────────────
COPY --from=firecrawl /app /opt/firecrawl
# Firecrawl's node_modules are built for Node 22; our base is Node 20.
# The compiled JS is compatible — only native addons would need a rebuild,
# and Firecrawl has none (pure JS + the bundled go-html-to-md binary).

# ── Copy Playwright service ─────────────────────────────
COPY --from=playwright-svc /usr/src/app /opt/playwright-service
# Copy Playwright browsers installed in the playwright-svc image
COPY --from=playwright-svc /usr/local/share/playwright /usr/local/share/playwright

# ── PostgreSQL init SQL ─────────────────────────────────
COPY nuq-postgres-init.sql /opt/postgres/nuq.sql

# ── Retail poller app ───────────────────────────────────
WORKDIR /app
RUN mv /tmp/tracker-blocklist.txt /app/tracker-blocklist.txt

COPY package.json ./
RUN npm install --omit=dev

# Spot-poller Python deps
RUN apt-get update && apt-get install -y --no-install-recommends python3-pip \
    && rm -rf /var/lib/apt/lists/* \
    && python3 -m pip install --no-cache-dir --break-system-packages "requests>=2.32.4" python-dotenv

COPY *.js ./
COPY run-local.sh run-goldback.sh run-spot.sh run-publish.sh run-retry.sh ./
RUN chmod +x run-local.sh run-goldback.sh run-spot.sh run-publish.sh run-retry.sh

# Spot-poller Python source (copied into build context by pre-deploy)
COPY spot-poller/ /app/spot-poller/

# Git config for committing
RUN git config --global user.name "StakTrakr Poller" \
    && git config --global user.email "poller@staktrakr.local"

# ── RabbitMQ setup (needs writable Erlang cookie + owned dirs) ──
RUN mkdir -p /var/lib/rabbitmq /var/log/rabbitmq \
    && echo "staktrakr-cookie" > /var/lib/rabbitmq/.erlang.cookie \
    && chmod 600 /var/lib/rabbitmq/.erlang.cookie \
    && chown -R rabbitmq:rabbitmq /var/lib/rabbitmq /var/log/rabbitmq

# ── Cron jobs ───────────────────────────────────────────
RUN (echo "15,45 * * * * root . /etc/environment; /app/run-local.sh >> /var/log/retail-poller.log 2>&1"; \
     echo "1 17 * * * root . /etc/environment; /app/run-goldback.sh >> /var/log/goldback-poller.log 2>&1") \
    > /etc/cron.d/retail-poller \
    && chmod 0644 /etc/cron.d/retail-poller

# ── Supervisord config ──────────────────────────────────
COPY supervisord.conf /etc/supervisor/conf.d/staktrakr.conf

# ── Entrypoint ──────────────────────────────────────────
COPY docker-entrypoint.sh /app/docker-entrypoint.sh
RUN chmod +x /app/docker-entrypoint.sh

EXPOSE 8080

ENTRYPOINT ["/app/docker-entrypoint.sh"]
CMD ["supervisord", "-n", "-c", "/etc/supervisor/supervisord.conf"]
