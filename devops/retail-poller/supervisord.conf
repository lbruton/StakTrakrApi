; StakTrakr All-in-One Supervisor Configuration
; Manages all services in a single Fly.io container.

; ── Backing Services (start first) ─────────────────────

[program:redis]
command=redis-server --bind 127.0.0.1 --port 6379 --save "" --appendonly no
autorestart=true
priority=10
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

[program:rabbitmq]
command=rabbitmq-server
user=rabbitmq
autorestart=true
priority=10
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
environment=RABBITMQ_LOG="-",HOME="/var/lib/rabbitmq"

[program:postgres]
command=/usr/lib/postgresql/17/bin/postgres -D /var/lib/postgresql/17/main -c config_file=/etc/postgresql/17/main/postgresql.conf
user=postgres
autorestart=true
priority=10
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

; ── Firecrawl Playwright Service (needs to be up before API) ──

[program:playwright-service]
command=node /opt/playwright-service/dist/api.js
directory=/opt/playwright-service
autorestart=true
priority=15
environment=PORT="3003",PLAYWRIGHT_BROWSERS_PATH="/usr/local/share/playwright",PROXY_SERVER="http://p.webshare.io:80",PROXY_USERNAME="%(ENV_WEBSHARE_PROXY_USER)s",PROXY_PASSWORD="%(ENV_WEBSHARE_PROXY_PASS)s"
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

; ── Firecrawl API ──────────────────────────────────────

[program:firecrawl-api]
command=node /opt/firecrawl/dist/src/index.js
directory=/opt/firecrawl
autorestart=true
priority=20
environment=HOST="0.0.0.0",PORT="3002",REDIS_URL="redis://localhost:6379",REDIS_RATE_LIMIT_URL="redis://localhost:6379",PLAYWRIGHT_MICROSERVICE_URL="http://localhost:3003/scrape",NUQ_RABBITMQ_URL="amqp://localhost:5672",POSTGRES_HOST="localhost",POSTGRES_PORT="5432",POSTGRES_USER="postgres",POSTGRES_PASSWORD="postgres",POSTGRES_DB="postgres",USE_DB_AUTHENTICATION="false",ENV="local",PROXY_SERVER="%(ENV_PROXY_SERVER)s"
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

; ── Firecrawl Worker ───────────────────────────────────

[program:firecrawl-worker]
command=node /opt/firecrawl/dist/src/services/queue-worker.js
directory=/opt/firecrawl
autorestart=true
priority=20
environment=REDIS_URL="redis://localhost:6379",REDIS_RATE_LIMIT_URL="redis://localhost:6379",PLAYWRIGHT_MICROSERVICE_URL="http://localhost:3003/scrape",NUQ_RABBITMQ_URL="amqp://localhost:5672",POSTGRES_HOST="localhost",POSTGRES_PORT="5432",POSTGRES_USER="postgres",POSTGRES_PASSWORD="postgres",POSTGRES_DB="postgres",FLY_PROCESS_GROUP="worker",ENV="local",PROXY_SERVER="%(ENV_PROXY_SERVER)s"
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

; ── Firecrawl Extract Worker ───────────────────────────

[program:firecrawl-extract-worker]
command=node /opt/firecrawl/dist/src/services/extract-worker.js
directory=/opt/firecrawl
autorestart=true
priority=20
environment=REDIS_URL="redis://localhost:6379",REDIS_RATE_LIMIT_URL="redis://localhost:6379",NUQ_RABBITMQ_URL="amqp://localhost:5672",POSTGRES_HOST="localhost",POSTGRES_PORT="5432",POSTGRES_USER="postgres",POSTGRES_PASSWORD="postgres",POSTGRES_DB="postgres",ENV="local"
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

; ── Retail Poller Cron ─────────────────────────────────

[program:cron]
command=cron -f
autorestart=true
priority=30
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

; ── HTTP API Server ────────────────────────────────────

[program:http-server]
command=node /app/serve.js
directory=/app
autorestart=true
priority=30
environment=API_EXPORT_DIR="/data/staktrakr-api-export"
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
